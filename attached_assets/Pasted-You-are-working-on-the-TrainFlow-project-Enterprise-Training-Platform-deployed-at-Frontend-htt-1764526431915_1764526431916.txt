You are working on the TrainFlow project (Enterprise Training Platform) deployed at:


Frontend: https://training.rocktech.sa


Backend: same project (Node/Express server folder: server/)


The app is almost complete. Email/password login UI exists and the /login page calls the backend and shows “logged in successfully”, but the session is not persisted, so /api/v1/users/me does not see the authenticated user and the frontend keeps behaving like the user is logged out.
Your task: fully fix the authentication session + routing flow without breaking any existing features.

1) CURRENT STATE (after your last changes)


POST /api/v1/users/login works with:


admin@democorp.local / TrainFlow123!




Frontend login page now correctly calls the login() method from useAuth and then redirects to /dashboard.


However, in the browser:


After login → toast shows success, URL = /dashboard.


But the app sometimes still behaves as “not authenticated” because /api/v1/users/me does not see the session.




In your last message you wrote that:

Login endpoint works ✅ but the session cookie isn't persisting between requests.
This is a remaining issue with how Express session cookies are being configured in the current environment…



That is exactly what needs to be fixed now.

2) REQUIRED FINAL BEHAVIOR
Target URL: https://training.rocktech.sa


Open /dashboard in a private window:


If NOT logged in → redirect to /login.




On /login:


Enter admin@democorp.local / TrainFlow123!.


On success:


Session is created on the server.


Cookie is stored in the browser.


Frontend auth state is updated.


User is redirected to /dashboard.






On /dashboard after login:


Show the authenticated dashboard layout (sidebar + cards).


No public landing hero.




Refresh /dashboard:


User must still be logged in (session cookie works).




Logout:


Session is cleared.


User redirected to / (public landing).




Do NOT change any business logic, AI features, jobs, DB schema, or landing content. Only fix session + auth + routing.

3) BACKEND – SESSION & /me ENDPOINT
3.1 Inspect session configuration
Check these files (names may vary, but you already referenced them):


server/index.ts or server/server.ts


server/replitAuth.ts


any place where express-session is configured


Verify:


app.use(session({ ... })) is called before the routes that handle:


POST /api/v1/users/login


GET /api/v1/users/me




Express session options are set correctly for HTTPS with a custom domain:
app.set('trust proxy', 1); // IMPORTANT when behind reverse proxy (Replit + custom domain)

app.use(session({
  secret: process.env.SESSION_SECRET || 'change-me',
  resave: false,
  saveUninitialized: false,
  cookie: {
    httpOnly: true,
    secure: true,          // because training.rocktech.sa is HTTPS
    sameSite: 'none',      // allow cross-site cookies between Replit default URL and custom domain
    // optionally: domain: '.rocktech.sa' if needed, otherwise default is fine
  }
}));



If secure: true is causing issues in the Replit environment, then:


In development only, you may conditionally use:
const isProd = process.env.NODE_ENV === 'production';

cookie: {
  httpOnly: true,
  secure: isProd,
  sameSite: isProd ? 'none' : 'lax',
}



But for the deployed environment at https://training.rocktech.sa we expect secure: true and sameSite: 'none'.




3.2 Ensure login and /me use the same session mechanism


In POST /api/v1/users/login:


After verifying email/password with bcrypt, make sure you attach the user to the session, e.g.:
req.session.user = {
  id: user.id,
  email: user.email,
  role: user.role,
  firstName: user.firstName,
  lastName: user.lastName,
  tenantId: user.tenant_id,
};



Return JSON with the same shape that the frontend expects.




In GET /api/v1/users/me:


Use the same source of truth:
app.get('/api/v1/users/me', (req, res) => {
  const sessionUser = req.session?.user;
  if (!sessionUser) {
    return res.status(401).json({ error: 'Not authenticated' });
  }
  return res.json(sessionUser);
});



Do NOT rely on the old Replit OIDC middleware for this endpoint anymore; use the email/password session only.




Make sure there is no mixed/conflicting auth:


If isAuthenticated middleware is still tied to Replit OIDC, do NOT use it for /api/v1/users/me.


Keep OIDC login only if it doesn’t break email/password. Email/password must be fully self-contained.





4) FRONTEND – AUTH & ROUTING VERIFICATION
4.1 useAuth hook
File: client/src/hooks/useAuth.ts
Requirements:


All authenticated API calls must include credentials:


If using fetch directly:
fetch('/api/v1/users/me', { credentials: 'include' });



If using Axios, set axios.defaults.withCredentials = true.




On app mount, the hook should:


Call /api/v1/users/me with credentials: 'include'.


Set:


user object from response.


isAuthenticated = true.




On 401/403:


user = null, isAuthenticated = false.






login(email, password) should:


Call /api/v1/users/login with credentials: 'include'.


On success, immediately refetch /api/v1/users/me to refresh auth state.


Only after that, resolve so that the caller (login.tsx) can safely navigate.




logout() should:


Call backend logout endpoint if present OR /api/v1/users/logout.


Clear local auth state and redirect to /.




4.2 Login page
File: client/src/pages/login.tsx


Must use const { login, isAuthenticated } = useAuth();


On submit:
await login(email, password);
navigate('/dashboard', { replace: true });



If isAuthenticated === true and user opens /login, redirect to /dashboard.


4.3 Router / ProtectedRoute


Ensure that /dashboard (and all app pages) are under a layout like:
<ProtectedRoute>
  <MainLayout>  {/* sidebar + header + <Outlet /> */}
    <DashboardPage />
  </MainLayout>
</ProtectedRoute>



ProtectedRoute should:


While loading === true → show spinner / nothing.


If isAuthenticated === false → redirect to /login.


If isAuthenticated === true → render children.





5) CORS CONFIG (IF NEEDED)
If the frontend makes API calls to a different origin (e.g., training.rocktech.sa → *.replit.app):


Make sure Express has:
app.use(cors({
  origin: [
    'https://training.rocktech.sa',
    'https://<YOUR-REPLIT-URL>.replit.app'
  ],
  credentials: true,
}));



And every fetch/Axios call includes credentials: 'include'.



6) ACCEPTANCE TESTS (you MUST run them in the browser)


Private window → open https://training.rocktech.sa/dashboard


Expect: redirect to /login.




On /login:


Enter admin@democorp.local / TrainFlow123!.


Expect:


No error.


Redirect to /dashboard.


Sidebar + dashboard visible (NOT public landing hero).






Refresh /dashboard:


Still logged in.


Still see dashboard.




Logout:


Redirect to /.


Visit /dashboard again → redirect to /login.




If any of these steps fail, continue to adjust only session/cookie/CORS/auth code until all are passing.
Stop when all tests pass. Do not change any UI, landing content, AI features, or database structure.

Use this as the single source of truth for fixing the remaining login/session issue.
