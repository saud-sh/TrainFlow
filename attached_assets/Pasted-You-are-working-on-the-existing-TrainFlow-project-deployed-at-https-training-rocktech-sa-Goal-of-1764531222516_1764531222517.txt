You are working on the existing TrainFlow project deployed at https://training.rocktech.sa.

Goal of this task:
Make the **Admin** role fully capable of managing:
1) Users (all roles)
2) Departments (with a designated manager)
3) All related CRUD operations with **real backend persistence**.

Do NOT change:
- Existing routes or URLs (/users, /departments, /dashboard, /login, etc.).
- Existing role types or names (admin, training_officer, manager, foreman, employee).
- Existing visual design (layout, theme, cards, tables, modal styles).
- Existing email/password login flow and sessions.

You MAY:
- Add or extend API endpoints in the backend.
- Add/extend React components, forms, modals, and hooks in the client.
- Add small utility functions or types.
- Adjust validation and error handling.

========================================
1) USER MANAGEMENT – ADMIN FULL CRUD
========================================
Current status: The /users page shows data from the DB, but I want the Admin to have **full control** over all user accounts from the UI, with changes saved in the database.

Implement the following behaviour:

A) Create User (Admin only)
- On /users, add an “Add User” button for admins that opens a modal.
- Modal fields:
  - First name
  - Last name
  - Email
  - Role (dropdown: Admin, Training Officer, Manager, Foreman, Employee)
  - Department (optional dropdown: from departments table)
  - Job title (optional)
  - Grade (optional)
  - Status (Active / Inactive)
  - Temporary password (optional – if omitted, generate a default like TrainFlow123! or a secure random)
- Submit should call **POST /api/v1/users** (or create this endpoint if it does not exist) and:
  - Insert into users table with proper role, department_id, and password hash.
  - Return the created user.
- Frontend should update the table immediately (optimistic update or refetch) so the new user appears in the list and counts at the top (Total Users, Employees, Supervisors, Admin Staff) are updated.

B) Edit User
- Clicking the edit icon in /users should open an “Edit User” modal prefilled with existing data.
- Admin must be able to change:
  - Role
  - Department
  - Job title
  - Grade
  - Status (Active/Inactive)
  - First/last name
- Implement **PUT /api/v1/users/:id** (or PATCH) that updates the DB row.
- After success, refresh the list or update the affected row in the table.

C) Optional: Reset Password
- If it’s already partially implemented, expose a “Reset Password” action for admin:
  - Backend endpoint, e.g. POST /api/v1/users/:id/reset-password.
  - Generates a new password and stores its hash.
  - Returns the new password so admin can copy it (or send via email later).

D) Permissions / Security
- Only admin can create/edit users.
- Non-admins must NOT see the Add User button or edit icons.
- Backend must enforce admin-only access via middleware (not just hidden UI).

========================================
2) DEPARTMENTS – CRUD + MANAGER ASSIGNMENT
========================================
I want the **Departments** page to be real and fully connected to the DB.

A) List Departments
- /departments should call GET /api/v1/departments.
- Data must come from the departments table (id, name, code/slug, manager_id, created_at, etc.).
- Show for each department:
  - Name
  - Manager (user’s full name if manager_id is set)
  - Number of employees in that department (count from users table)
  - Created date

B) Create Department
- “Add Department” button for admin:
  - Fields:
    - Name
    - Code/slug (optional, must be unique if used)
    - Manager (dropdown of users with role = Manager / Foreman / Training Officer – choose your logic, but at least allow Manager)
  - POST /api/v1/departments should:
    - Insert department row.
    - Set manager_id.
  - After success, refresh the department list.
  - Also, consider updating the manager’s department_id in users table if appropriate.

C) Edit Department
- Edit icon should open a modal:
  - Change name, manager, and possibly code/slug.
- PUT /api/v1/departments/:id updates DB.
- If manager is changed:
  - Update manager_id in departments table.
  - Optionally, sync department_id of the chosen manager in users table.

D) Assign/Change Manager from Users page (Optional but nice)
- In the Edit User modal, if role is Manager, allow selecting their department.
- This should:
  - Update user.department_id.
  - Optionally, if “Is Department Manager” checkbox is checked, set that user as manager_id for that department.

========================================
3) BACKEND PERSISTENCE – VERIFY EVERYTHING HITS THE DB
========================================
For all of the above, ensure **real persistence**:

- Creating a user must create a row in users.
- Editing a user updates the existing row.
- Creating a department creates a row in departments.
- Editing a department updates the row.
- Assigning a manager updates manager_id (and possibly user.department_id).
- All changes are visible if we inspect the Postgres tables directly.

Add or adjust API endpoints under backend/app/api/v1/ and service layer files so the logic is clean, reusable, and consistent with the existing architecture.

After changes, confirm:
- /users and /departments screens are fully driven by those APIs.
- There is no hardcoded or mock data left.
- All requests send credentials (cookies) so auth is respected.

========================================
4) ROLE-AWARE UX CHECK
========================================
Finally, verify these behaviour rules:

- Admin:
  - Sees /users and /departments.
  - Can create/update users and departments.
  - Can assign roles and department managers.

- Manager / Foreman / Employee:
  - Can view only what is allowed by the current design.
  - Cannot create or edit users or departments (both UI and backend enforcement).

If you need to adjust any existing hooks/components (e.g., useApi, useAuth, or router guards), do it minimally and safely.

At the end:
- Update replit.md with a short “User & Department Management” section summarizing:
  - Which endpoints exist.
  - What admin can do from the UI.
  - Any special behaviours (e.g., how manager assignment is stored).

Make sure everything is working end-to-end in the real app using the existing demo credentials.
